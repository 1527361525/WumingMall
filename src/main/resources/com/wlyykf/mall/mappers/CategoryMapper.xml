<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.wlyykf.mall.mappers.CategoryMapper">

    <update id="deleteCategoryRecursively">
        WITH RECURSIVE category_tree AS (
            SELECT category_id
            FROM tb_category
            WHERE category_id = #{id}
            AND del_flag = 0
            UNION ALL
            SELECT c.category_id
            FROM tb_category c
            JOIN category_tree ct ON c.parent_id = ct.category_id
            WHERE c.del_flag = 0
        )
        UPDATE tb_category
        SET del_flag = 1
        WHERE category_id IN (
            SELECT category_id FROM category_tree
        )
        AND del_flag = 0
    </update>

    <update id="deleteRelatedProducts">
        WITH RECURSIVE category_tree AS (
            SELECT category_id
            FROM tb_category
            WHERE category_id = #{id}
              AND del_flag = 0
            UNION ALL
            SELECT c.category_id
            FROM tb_category c
                     JOIN category_tree ct ON c.parent_id = ct.category_id
            WHERE c.del_flag = 0
        )
        UPDATE tb_product
        SET del_flag = 1
        WHERE category_id IN (
            SELECT category_id FROM category_tree
        )
        AND del_flag = 0
    </update>

    <select id="getChildren" resultType="com.wlyykf.mall.vo.CategoryVO">
        SELECT
            category_id AS categoryId,
            name AS name
        FROM tb_category
        WHERE parent_id = #{parentId}
        AND del_flag = 0
        ORDER BY sort DESC, update_time DESC
    </select>

    <select id="hasChildren" resultType="boolean">
        SELECT EXISTS(
            SELECT 1
            FROM tb_category
            WHERE parent_id = #{id}
            AND del_flag = 0
        )
    </select>

</mapper>
