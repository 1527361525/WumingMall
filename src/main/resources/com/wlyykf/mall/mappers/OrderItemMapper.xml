<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.wlyykf.mall.mappers.OrderItemMapper">

    <select id="getOrderItemByOrderId" resultType="com.wlyykf.mall.vo.OrderItemVO">
        SELECT
            product_id AS productId,
            product_name AS productName,
            quantity,
            price,
            total_price AS totalPrice,
            product_image AS productImage
        FROM
            tb_order_item
        WHERE
            order_id = #{orderId}
    </select>

    <select id="getProductTopN" resultType="com.wlyykf.mall.vo.ProductVO">
        SELECT
            oi.product_id AS productId,
            oi.product_name AS name,
            oi.product_image AS productImage,
            SUM(oi.quantity) AS totalSales
        FROM
            tb_order_item oi
        INNER JOIN
            tb_order o
        ON oi.order_id = o.order_id
        WHERE
            o.payment_time IS NOT NULL
            AND o.del_flag = 0
            AND oi.del_flag = 0
        <if test="startDate != null">
            AND o.create_time >= #{startDate}
        </if>
        <if test="endDate != null">
            AND o.create_time &lt; #{endDate}
        </if>
        GROUP BY oi.product_id, oi.product_name, oi.product_image
        ORDER BY totalSales DESC
        LIMIT #{topN}
    </select>

</mapper>
